<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Proxy</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #fff; color: #202124; }
        .wrap { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; padding: 0 16px; }
        .hero { position: fixed; left: 50%; top: 32vh; transform: translate(-50%, -50%); width: 100%; max-width: 860px; display: flex; flex-direction: column; align-items: center; gap: 20px; padding: 0 8px; }
        .logo { font-size: 42px; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 28px; }
        .logo .accent { color: #1a73e8; }
        .search { width: 100%; max-width: 680px; display: flex; gap: 10px; }
        .search input { flex: 1; height: 48px; padding: 0 16px; border: 1px solid #dadce0; border-radius: 24px; font-size: 16px; outline: none; }
        .search input:focus { box-shadow: 0 1px 6px rgba(32,33,36,.28); border-color: transparent; }
        .search button { height: 48px; padding: 0 18px; border: none; background: #1a73e8; color: #fff; border-radius: 24px; cursor: pointer; font-size: 14px; }
        .search button:hover { background: #1765cc; }
        .result { margin-top: 20px; width: 100%; max-width: 680px; font-family: monospace; word-break: break-all; }
        .result-fixed { position: fixed; left: 50%; transform: translateX(-50%); top: calc(32vh + 120px); width: 100%; max-width: 680px; padding: 0; }
        .result-card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; background: #fafafa; box-shadow: 0 1px 2px rgba(0,0,0,.06), 0 4px 12px rgba(0,0,0,.04); }
        .result-card .url-line { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 13px; line-height: 1.6; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .result-card .note { color: #5f6368; font-size: 12px; margin-top: 8px; display: flex; gap: 8px; align-items: center; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; line-height: 1.4; }
        .badge.success { background: #e8f5e9; color: #1e8e3e; border: 1px solid #c8e6c9; }
        .badge.warn { background: #fff4e5; color: #b06a00; border: 1px solid #ffe0b2; }
        .result-card .actions { margin-top: 10px; display: flex; gap: 8px; }
        .result-card .actions .push-right { margin-left: auto; }
        .btn-copy { height: 36px; padding: 0 14px; border: 1px solid #dadce0; background: #fff; color: #202124; border-radius: 10px; cursor: pointer; font-size: 13px; }
        .btn-copy:hover { background: #f3f4f6; }
        .toast { position: fixed; right: 16px; top: 16px; background: #202124; color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 12px; opacity: 0; transform: translateY(-6px); transition: all .2s ease; pointer-events: none; }
        .toast.show { opacity: 1; transform: translateY(0); }
        @media (prefers-color-scheme: dark) {
          body { background: #fff; color: #202124; }
          .search input { border-color: #dadce0; background: #fff; color: #202124; }
          .search input:focus { box-shadow: 0 1px 6px rgba(32,33,36,.28); border-color: transparent; }
          .result-card { background: #fafafa; border-color: #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,.06), 0 4px 12px rgba(0,0,0,.04); }
          .btn-copy { background: #fff; color: #202124; border-color: #dadce0; }
          .btn-copy:hover { background: #f3f4f6; }
          .footer .footer-line, .footer .link-green { color: #000; }
        }
        .tip { margin-top: 16px; color: #5f6368; font-size: 12px; }
        .footer { position: fixed; bottom: 10px; left: 0; right: 0; text-align: center; color: #5f6368; font-size: 12px; }
        .footer .footer-line { color: #000; font-size: 12px; letter-spacing: 0.5px; line-height: 1.5; }
        .footer .link-green { color: #000; text-decoration: none; transition: color .2s ease; font-weight: 600; text-underline-offset: 2px; position: relative; }
        .footer .link-green::after { content: ""; position: absolute; left: 0; right: 0; bottom: -2px; height: 2px; background-color: currentColor; transform: scaleX(0); transform-origin: center; transition: transform .25s ease; border-radius: 2px; }
        .footer .link-green:hover::after { transform: scaleX(1); }
    </style>
    <meta name="description" content="GitHub 文件加速代理服务，支持白名单和智能切换 jsDelivr。">
    <meta name="robots" content="index,follow">
    <meta name="color-scheme" content="light dark">
</head>
<body>
    <div class="wrap">
        <div class="hero">
            <div class="logo">GitHub <span class="accent">Proxy</span></div>
            <div class="search">
            <input id="githubUrl" type="text" placeholder="粘贴 GitHub 链接，例如：https://github.com/user/repo/archive/main.zip" />
            <button onclick="generateProxyUrl()">生成链接</button>
            </div>
        </div>
        <div id="result" class="result result-fixed" style="display:none;"></div>
    </div>
    <footer class="footer">
        <div class="footer-line">© 2025 <a href="https://cdn.gw124.com/" target="_blank" rel="noopener noreferrer" class="link-green">CDN.GW124.COM</a>｜By <a href="https://gw124.com/" target="_blank" rel="noopener noreferrer" class="link-green">Wen</a></div>
    </footer>

    <script>
        let currentDomain = window.location.origin;
        if (currentDomain.startsWith('file://')) { currentDomain = 'https://cdn.gw124.top'; }

        // 页面加载时拉取 config.json；本地/跨域测试默认不启用严格白名单
        let CFG = { enabled: false, strictMode: false, jsDelivr: true };
        let WL = ['GWen124/','SuiYue124/'];
        let ASSET_URL = currentDomain;
        (async ()=>{
            try{
                const res = await fetch((window.location.origin.startsWith('file://') ? currentDomain : '') + '/config.json', { cache: 'no-store' });
                if(res.ok){
                  const data = await res.json();
                  CFG = { enabled: !!data.ENABLED, strictMode: !!data.STRICT_MODE, jsDelivr: !!data.JSDELIVR };
                  WL = Array.isArray(data.WHITE_LIST) ? data.WHITE_LIST : WL;
                  if (typeof data.ASSET_URL === 'string' && data.ASSET_URL) ASSET_URL = data.ASSET_URL;
                }
            }catch(_){ /* 忽略：离线 file:// 预览无后端 */ }
            // 生产环境不再支持通过 URL 参数覆盖开关，避免误用
        })();

        async function generateProxyUrl() {
            const input = document.getElementById('githubUrl');
            const result = document.getElementById('result');
            const url = (input.value || '').trim();
            if (!url) { alert('请输入 GitHub 链接'); return; }

            const patterns = ['github.com','raw.githubusercontent.com','gist.githubusercontent.com','raw.github.com','gist.github.com'];
            if (!patterns.some(p=>url.includes(p))) { alert('请输入有效的 GitHub 链接'); return; }

            function parseOwnerRepo(u){
                try{
                    if(u.includes('raw.githubusercontent.com')){
                        const m = u.match(/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\//i); if(m) return { owner:m[1], repo:m[2] };
                    } else if(u.includes('github.com')){
                        const m = u.match(/github\.com\/([^\/]+)\/([^\/]+)/i); if(m) return { owner:m[1], repo:m[2] };
                    }
                }catch(_){ }
                return null;
            }
            let isWL = false;
            if (CFG.strictMode) {
                const or = parseOwnerRepo(url);
                if(or){
                    const owner = or.owner.toLowerCase();
                    const repo = or.repo.toLowerCase();
                    isWL = WL.some(entry=>{
                        const e = String(entry||'');
                        if(!e) return false;
                        if(e.endsWith('/')){ // org/owner
                            return owner === e.slice(0,-1).toLowerCase();
                        } else {
                            const [eo,er] = e.split('/');
                            return (eo && er) ? (owner===eo.toLowerCase() && repo===er.toLowerCase()) : false;
                        }
                    });
                }
            }

            let finalUrl, note;
            if (CFG.enabled && CFG.strictMode && !isWL) {
                result.style.display='block';
                result.innerHTML = '<div class="result-card"><div class="note"><span style="color:#d93025">❌ 非白名单仓库，已被禁止</span></div></div>';
                return;
            } else if (!CFG.enabled && CFG.strictMode && !isWL) {
                // 关闭白名单校验但仍处于严格模式：非白名单直接走 jsDelivr
                finalUrl = convertToJsDelivr(url);
                note = '⚠️ 非白名单仓库，使用 jsDelivr 代理';
                const isSuccess = false;
                const badge = '<span class="badge ' + (isSuccess ? 'success' : 'warn') + '">' + (isSuccess ? '本代理' : 'jsDelivr') + '</span>';
                result.style.display='block';
                result.innerHTML = '<div class="result-card">'
                  + '<div class="url-line"><a href="' + finalUrl + '" target="_blank" title="' + finalUrl + '">' + finalUrl + '</a></div>'
                  + '<div class="note">' + badge + '<span>' + note + '</span></div>'
                  + '<div class="actions"><button class="btn-copy" id="copyBtn">点击复制链接</button><button class="btn-copy push-right" id="openBtn">点击打开链接</button></div>'
                  + '</div>';
                const copyBtn1 = document.getElementById('copyBtn');
                copyBtn1?.addEventListener('click', () => copyToClipboard(finalUrl));
                const openBtn1 = document.getElementById('openBtn');
                openBtn1?.addEventListener('click', () => window.open(finalUrl, '_blank'));
                return;
            } else {
                // 仅白名单允许尝试本代理；非白名单的处理：
                // - 严格模式且关闭校验（ENABLED=false, STRICT_MODE=true）：直接 jsDelivr
                // - 其他情况：也走 jsDelivr（更安全）
                if (!isWL) {
                    if (!CFG.enabled && CFG.strictMode) {
                        finalUrl = convertToJsDelivr(url);
                        note = '⚠️ 非白名单仓库，使用 jsDelivr 代理';
                    } else {
                        finalUrl = convertToJsDelivr(url);
                        note = '⚠️ 非白名单仓库，使用 jsDelivr 代理';
                    }
                    const isSuccess = false;
                    const badge = '<span class="badge ' + (isSuccess ? 'success' : 'warn') + '">' + (isSuccess ? '本代理' : 'jsDelivr') + '</span>';
                    result.style.display='block';
                    result.innerHTML = '<div class="result-card">'
                      + '<div class="url-line"><a href="' + finalUrl + '" target="_blank" title="' + finalUrl + '">' + finalUrl + '</a></div>'
                      + '<div class="note">' + badge + '<span>' + note + '</span></div>'
                      + '<div class="actions"><button class="btn-copy" id="copyBtn">点击复制链接</button><button class="btn-copy push-right" id="openBtn">点击打开链接</button></div>'
                      + '</div>';
                    const copyBtn = document.getElementById('copyBtn');
                    copyBtn?.addEventListener('click', () => copyToClipboard(finalUrl));
                    const openBtn = document.getElementById('openBtn');
                    openBtn?.addEventListener('click', () => window.open(finalUrl, '_blank'));
                } else {
                    // 白名单：同时生成 本地 与 jsDelivr 两个链接
                    const localUrl = ASSET_URL + '/' + url;
                    const jsdUrl = convertToJsDelivr(url);
                    const localOk = await headCheck(localUrl);
                    const localBadge = '<span class="badge ' + (localOk ? 'success' : 'warn') + '">' + (localOk ? '本地可用' : '本地不可用') + '</span>';
                    const jsdBadge = '<span class="badge success">jsDelivr</span>';
                    result.style.display='block';
                    result.innerHTML = '<div class="result-card">'
                      + '<div class="url-line"><a href="' + localUrl + '" target="_blank" title="' + localUrl + '">' + localUrl + '</a></div>'
                      + '<div class="note">' + localBadge + '<span>白名单仓库，本地优先（失败可切换 jsDelivr）</span></div>'
                      + '<div class="actions"><button class="btn-copy" id="copyLocalBtn">复制本地链接</button><button class="btn-copy push-right" id="openLocalBtn">打开本地链接</button></div>'
                      + '<hr style="margin:12px 0;border:none;border-top:1px dashed #e5e7eb;" />'
                      + '<div class="url-line"><a href="' + jsdUrl + '" target="_blank" title="' + jsdUrl + '">' + jsdUrl + '</a></div>'
                      + '<div class="note">' + jsdBadge + '<span>备用 CDN 链接</span></div>'
                      + '<div class="actions"><button class="btn-copy" id="copyJsdBtn">复制 jsDelivr</button><button class="btn-copy push-right" id="openJsdBtn">打开 jsDelivr</button></div>'
                      + '</div>';
                    document.getElementById('copyLocalBtn')?.addEventListener('click', () => copyToClipboard(localUrl));
                    document.getElementById('openLocalBtn')?.addEventListener('click', () => window.open(localUrl, '_blank'));
                    document.getElementById('copyJsdBtn')?.addEventListener('click', () => copyToClipboard(jsdUrl));
                    document.getElementById('openJsdBtn')?.addEventListener('click', () => window.open(jsdUrl, '_blank'));
                }
            }
        }

        async function copyToClipboard(text) {
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                } else {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    ta.style.position = 'fixed';
                    ta.style.opacity = '0';
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                }
                showToast('已复制到剪贴板');
            } catch (e) {
                showToast('复制失败，请手动复制');
            }
        }

        function showToast(text){
            let el = document.getElementById('toast');
            if(!el){ el = document.createElement('div'); el.id='toast'; el.className='toast'; document.body.appendChild(el); }
            el.textContent = text; el.classList.add('show');
            setTimeout(()=> el.classList.remove('show'), 1800);
        }

        async function headCheck(u, timeoutMs = 1800) {
            try {
                const ctrl = new AbortController();
                const timer = setTimeout(()=>ctrl.abort(), timeoutMs);
                const res = await fetch(u, { method: 'HEAD', mode: 'cors', signal: ctrl.signal });
                clearTimeout(timer);
                const ct = res.headers.get('content-type') || '';
                return res.ok && !ct.includes('text/html');
            } catch (_) { return false; }
        }

        function convertToJsDelivr(url) {
            if (url.includes('raw.githubusercontent.com')) {
                const m = url.match(/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.+)/);
                if (m) {
                    let branch = m[3];
                    const r = branch.match(/^refs\/heads\/([^\/]+)$/);
                    if (r) branch = r[1];
                    return 'https://cdn.jsdelivr.net/gh/' + m[1] + '/' + m[2] + '@' + branch + '/' + m[4];
                }
            } else if (url.includes('github.com')) {
                const m = url.match(/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)/); if (m) { return 'https://cdn.jsdelivr.net/gh/' + m[1] + '/' + m[2] + '@' + m[3] + '/' + m[4]; }
                const a = url.match(/github\.com\/([^\/]+)\/([^\/]+)\/archive\/([^\/]+)\.zip/); if (a) { return 'https://cdn.jsdelivr.net/gh/' + a[1] + '/' + a[2] + '@' + a[3]; }
            }
            return url;
        }

        document.getElementById('githubUrl').addEventListener('keypress', function(e){ if(e.key==='Enter'){ generateProxyUrl(); }});
    </script>
</body>
</html>


